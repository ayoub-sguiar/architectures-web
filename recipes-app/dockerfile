# üåü √âtape 1: Construire l'application avec Node.js
FROM node:20-alpine AS builder

# D√©finir le r√©pertoire de travail dans le conteneur
WORKDIR /app

# Copier les fichiers n√©cessaires
COPY package.json package-lock.json ./

# Installer les d√©pendances
RUN npm install

# Copier tout le code source
COPY . .

# D√©finir le port 80 comme port d'ex√©cution
ENV NODE_ENV=production \
    NEXT_TELEMETRY_DISABLED=1 \
    PORT=80

# Compiler l'application Next.js
RUN npm run build

# üåü √âtape 2: Ex√©cuter l'application dans une image plus l√©g√®re
FROM node:20-alpine

# D√©finir le r√©pertoire de travail
WORKDIR /app

# Copier les fichiers n√©cessaires depuis l'√©tape builder
COPY --from=builder /app/package.json /app/package-lock.json ./
COPY --from=builder /app/.next .next
COPY --from=builder /app/public public
COPY --from=builder /app/node_modules node_modules

# D√©finir le port d'ex√©cution de l'application
ENV PORT=80

# Exposer le port 80
EXPOSE 80

# D√©marrer l'application Next.js sur le port 80
CMD ["npm", "run", "start", "--", "-p", "80"]
